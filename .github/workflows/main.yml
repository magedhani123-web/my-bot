name: Run My Bot Forever

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

permissions:
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"
      # ╪▓┘К╪з╪п╪й ┘Г┘Б╪з╪б╪й ╪з┘Д╪░╪з┘Г╪▒╪й ┘Д┘Д┘Е╪╣╪з┘Д╪м
      NODE_OPTIONS: "--max-old-space-size=4096"

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Maximize CPU Performance
        run: |
          sudo sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="/&mitigations=off /' /etc/default/grub || true
          echo "ЁЯЪА CPU Resources Optimized"

      - name: Install Google Chrome Stable
        run: |
          sudo apt-get update
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt install -y ./google-chrome-stable_current_amd64.deb

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          # ╪к┘Е ╪з┘Д╪е╪и┘В╪з╪б ╪╣┘Д┘Й libasound2t64 ┘Д╪╢┘Е╪з┘Ж ╪з┘Д╪к┘И╪з┘Б┘В
          sudo apt-get install -y tor xvfb libnss3 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 libxrandr2 libgbm1 libasound2t64 ffmpeg
          pip install undetected_chromedriver selenium requests

      - name: Configure and Start Tor
        run: |
          sudo service tor stop || true
          sudo bash -c 'echo -e "ControlPort 9051\nCookieAuthentication 0\nDataDirectory /var/lib/tor" > /etc/tor/torrc'
          sudo service tor start
          sleep 20

      - name: Start Bot (High Performance Mode)
        run: |
          # ╪е╪╢╪з┘Б╪й --server-num ┘Д╪╢┘Е╪з┘Ж ╪╣╪п┘Е ╪к╪п╪з╪о┘Д ╪з┘Д╪м┘Д╪│╪з╪к ┘И╪к┘И┘Б┘К╪▒ ┘И╪з╪м┘З╪й ╪▒╪│┘И┘Е┘К╪й ┘Е╪│╪к┘В╪▒╪й
          timeout 350m xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24 -ac +extension GLX +render -noreset" python -u bot_master1.py || echo "тЪая╕П Session ended"

      - name: Self-Restart Workflow
        if: always()
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "ЁЯЪА Triggering self-restart..."
          gh workflow run "Run My Bot Forever"
